<!doctype html>
<html lang="el" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="utf-8"/>
    <meta name="viewport" content="width=device-width, initial-scale=1"/>
    <title>PetCare — SMS Monitor</title>

    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">

    <style>
        .mono { font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace; }
    </style>
</head>

<body class="bg-light">
<div class="container py-4">

    <div class="d-flex align-items-center justify-content-between mb-3">
        <div>
            <h3 class="mb-0">Notification Service Monitor</h3>
            <div class="text-muted">
                Base URL: <span id="baseUrl" class="mono"></span>
                <span class="mx-2">•</span>
                Last updated: <span id="lastUpdated" class="mono">—</span>
            </div>
        </div>

        <div class="d-flex gap-2">
            <button id="btnRefresh" class="btn btn-outline-secondary btn-sm">Refresh</button>
            <button id="btnClear" class="btn btn-outline-danger btn-sm">Clear</button>
        </div>
    </div>

    <!-- Αν πέσει το endpoint, δείχνουμε ένα απλό μήνυμα -->
    <div id="errorBox" class="alert alert-warning d-none" role="alert">
        Δεν μπορώ να φορτώσω events. Δες αν τρέχει η υπηρεσία (notification_service).
    </div>

    <div class="card shadow-sm">
        <div class="card-header d-flex justify-content-between align-items-center">
            <span>Last SMS events</span>
            <span id="countBadge" class="badge bg-secondary">0</span>
        </div>

        <div class="table-responsive">
            <table class="table table-striped table-hover mb-0 align-middle">
                <thead>
                <tr>
                    <th style="width: 190px;">Time</th>
                    <th style="width: 170px;">To (E.164)</th>
                    <th>Content</th>
                    <th style="width: 110px;">Status</th>
                </tr>
                </thead>
                <tbody id="eventsBody">
                <tr>
                    <td colspan="4" class="text-center text-muted py-4">
                        Waiting for events… (κάνε ένα appointment)
                    </td>
                </tr>
                </tbody>
            </table>
        </div>
    </div>

    <div class="text-muted mt-3 small">
        JSON feed: <span class="mono">GET /api/v1/monitor/sms-events</span>
    </div>

</div>

<script>

    const API_LIST = "/api/v1/monitor/sms-events?limit=50";
    const API_CLEAR = "/api/v1/monitor/sms-events/clear";
    const POLL_MS = 2000;

    // ====== στοιχεία DOM ======
    const body = document.getElementById("eventsBody");
    const badge = document.getElementById("countBadge");
    const errorBox = document.getElementById("errorBox");
    const baseUrlEl = document.getElementById("baseUrl");
    const lastUpdatedEl = document.getElementById("lastUpdated");

    const btnRefresh = document.getElementById("btnRefresh");
    const btnClear = document.getElementById("btnClear");

    let timerId = null;

    // δείχνουμε το host που είμαστε αντι για  hardcoded localhost
    baseUrlEl.textContent = window.location.origin;

    // κουμπιά
    btnRefresh.addEventListener("click", loadEvents);

    btnClear.addEventListener("click", async () => {
        const ok = confirm("Σίγουρα θες να καθαρίσεις τα events;");
        if (!ok) return;

        try {
            await fetch(API_CLEAR, { method: "POST" });
            await loadEvents();
        } catch (e) {
            showError(true);
        }
    });

    function showError(on) {
        errorBox.classList.toggle("d-none", !on);
    }

    function setBadge(count) {
        badge.textContent = String(count);
    }

    function setLastUpdatedNow() {
        lastUpdatedEl.textContent = new Date().toLocaleString("el-GR");
    }

    // Εμφάνιση ώρας: αν το backend δίνει ISO, το κάνουμε readable.
    function formatAt(value) {
        if (!value) return "";
        const d = new Date(value);
        return isNaN(d.getTime()) ? value : d.toLocaleString("el-GR");
    }

    function renderEmpty(text) {
        body.innerHTML = "";
        const tr = document.createElement("tr");
        const td = document.createElement("td");
        td.colSpan = 4;
        td.className = "text-center text-muted py-4";
        td.textContent = text;
        tr.appendChild(td);
        body.appendChild(tr);
    }


    function renderRows(events) {
        body.innerHTML = "";

        for (const e of events) {
            const tr = document.createElement("tr");

            const tdAt = document.createElement("td");
            tdAt.className = "mono";
            tdAt.textContent = formatAt(e.at);

            const tdTo = document.createElement("td");
            tdTo.className = "mono";
            tdTo.textContent = e.toE164 ?? "";

            const tdContent = document.createElement("td");
            tdContent.textContent = e.content ?? "";

            const tdStatus = document.createElement("td");
            const badgeSpan = document.createElement("span");
            badgeSpan.className = "badge " + (e.sent ? "bg-success" : "bg-danger");
            badgeSpan.textContent = e.sent ? "SENT" : "FAILED";
            tdStatus.appendChild(badgeSpan);

            tr.append(tdAt, tdTo, tdContent, tdStatus);
            body.appendChild(tr);
        }
    }

    async function loadEvents() {
        try {
            showError(false);

            const res = await fetch(API_LIST);
            if (!res.ok) throw new Error("HTTP " + res.status);

            const data = await res.json();

            setBadge(data.length);
            setLastUpdatedNow();

            if (!data.length) {
                renderEmpty("No events yet…");
                return;
            }

            renderRows(data);
        } catch (e) {
            showError(true);
            // αν δεν έχουμε τίποτα να δείξουμε
            if (!body.children.length) {
                renderEmpty("Cannot load events…");
            }
        }
    }

    function startPolling() {
        if (timerId) return;
        timerId = setInterval(loadEvents, POLL_MS);
    }

    function stopPolling() {
        if (!timerId) return;
        clearInterval(timerId);
        timerId = null;
    }

    // Όταν ο χρήστης αλλάζει tab, σταματάμε το polling για να μην βαράει άσκοπα
    document.addEventListener("visibilitychange", () => {
        if (document.visibilityState === "visible") {
            loadEvents();
            startPolling();
        } else {
            stopPolling();
        }
    });

    // αρχικό load
    loadEvents();
    startPolling();
</script>
</body>
</html>
